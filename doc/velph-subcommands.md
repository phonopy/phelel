(velph_subcommands)=
# `velph` subcommands

The `velph` subcommands, except for {ref}`velph_init` and {ref}`velph_hints`,
are explained on this page.

The following subcommands must be executed in the directory containing the
`velph.toml` file. This ensures that the directories and files generated are
properly organized relative to the current directory where `velph.toml` is
located.

A typical workflow of velph subcommands for transport property calculation is illustrated below.

```{mermaid}
graph LR
A[velph-init] --> B[velph-relax]
B --> C[velph-init]
C --> D[velph-nac]
C --> E[velph-el_bands]
F[velph-phelel]
D --> F
E --> F
F --> G[velph-transport]
```

In the following example, two `velph init` command operations generate two
different directories. The first operation performs crystal structure relaxation
in the `relax` directory. The second operation, using the relaxed crystal
structure, carries out additional calculations required for electron-phonon
interactions in the `calc` directory. Details about `velph-tmpl.toml` are
described in {ref}`velph_init_template`.

```bash
% ls
POSCAR-unitcell  POTCAR  velph-tmpl.toml
% velph init --template-toml velph-tmpl.toml POSCAR-unitcell relax
...
% cd relax
% velph relax generate
...
# Run VASP relaxation calculation
...
% cd ..
% ls
POSCAR-unitcell  POTCAR  relax/  velph-tmpl.toml
% velph init --template-toml velph-tmpl.toml `ls relax/relax/iter*/CONTCAR|tail -n 1` calc
...
% cd calc
% ls
POTCAR  velph.toml
% velph nac generate
VASP input files were made in "nac".
% ls
POTCAR  nac/  velph.toml
...
# Run NAC calculation
...
% velph phelel init
Found "nac" directory. Read NAC params.
"phelel/phelel_disp.yaml" was generated.
VASP input files will be generated by "velph phelel generate".
% velph phelel generate
VASP input files were generated in "phelel/disp-000".
VASP input files were generated in "phelel/disp-001".
VASP input files were generated in "phelel/disp-002".
VASP input files were generated in "phelel/disp-003".
VASP input files were generated in "phelel/disp-004".
% ls
POTCAR  nac/  phelel/  velph.toml
% velph phelel init
Found "nac" directory. Read NAC params.
"phelel/phelel_disp.yaml" was generated.
VASP input files will be generated by "velph phelel generate".
...
```

## `velph init`

See {ref}`velph_init`.

## `velph hints`

See {ref}`velph_hints`.

## `velph relax`

It is recommended to create a project directory secific for relaxation
calculation, e.g., as

```bash
% ls
POSCAR-unitcell  POTCAR  velph-tmpl.toml
% velph init --template-toml velph-tmpl.toml POSCAR-unitcell relax
...
% cd relax
% ls
POTCAR  velph.toml
% velph relax generate
...
```
### `velph relax generate`

This subcommand generates VASP input files and a job script for crystal
structure relaxation. Initially, these files are created in the `iter1`
directory. The process supports multiple relaxation steps, where the `CONTCAR`
file from the previous iteration is used as the `POSCAR` for the next step once
the preceding VASP calculation is complete. Each subsequent set of input files
is generated in directories named `iter2`, `iter3`, and so on.

```bash
% ls
POTCAR  velph.toml
% velph relax generate
VASP input files were made in "relax/iter1".
...
# Run VASP calculation in relax/iter1
...
% ls
POTCAR  relax/  velph.toml
% velph relax generate
"relax/iter1" exists.
"relax/iter1/CONTCAR" will be as new "POSCAR".
VASP input files were made in "relax/iter2".
...
```

(velph_nac_subcommand)=
## `velph nac`

This subcommand is used to prepare VASP input files for calculating the
dielectric constant and Born effective charges. These quantities are required
for the non-analytical term correction in phonon calculations and for handling
the long-range terms in electron-phonon interaction calculations.

### `velph nac generate`

After the VASP calculation is complete, the dielectric constant and Born
effective charges are extracted from the `vasprun.xml` file during the execution
of `velph phelel init`, `velph phono3py init`, or `velph phonopy init`. The
extracted values are then written to `phelel_disp.yaml`, `phono3py_disp.yaml`,
or `phonopy_disp.yaml`, respectively.

```bash
% velph nac generate
VASP input files were made in "nac".
```

## `velph el_bands`

This subcommand is used to prepare VASP input files for electronic band
structure and density of states calculations, and to plot the resulting data.

### `velph el_bands generate`

The VASP input files have been prepared so that the calculation results will be
stored in `vaspout.h5`.

```bash
% velph el_bands generate
VASP input files were made in "el_bands/bands".
VASP input files were made in "el_bands/dos".
```

### `velph el_bands plot`

The electronic band structure and density of states are plotted and saved in the
`el_bands.pdf` file. The energy range must be specified using the `--windows`
option, with the first and second arguments representing the range below and
above the Fermi energy in eV, respectively.

```bash
% velph el_bands plot --window -5 9
Electronic band structure plot was saved in "el_bands/el_bands.pdf".
```

## `velph phelel`

This subcommand calculates the derivatives of local potentials and PAW strengths
with respect to displacement, performing similar operations as steps 1 and 3
carried out by the `phelel` command in the {ref}`workflow <workflow_minimal>`.

The subcommands below should be executed in the following order:

1. {ref}`velph_phelel_init_subcommand`
2. {ref}`velph_phelel_generate_subcommand`
3. {ref}`velph_phelel_differentiate_subcommand`
4. {ref}`velph_phelel_phonopy_subcommand` (optional)

(velph_phelel_init_subcommand)=
### `velph phelel init`

This subcommand generates the `phelel_disp.yaml` file, which contains
information about the supercell structure and displacements. It is recommended
to generate `phelel_disp.yaml` after performing the NAC calculation (see
{ref}`velph_nac_subcommand`). At this stage, the dielectric constant and Born
effective charges are written to `phelel_disp.yaml`, and these values are
ultimately stored in `phelel_params.hdf5` through the `phelel_disp.yaml` file.

```bash
% velph phelel init
Found "nac" directory. Read NAC params.
"phelel/phelel_disp.yaml" was generated.
VASP input files will be generated by "velph phelel generate".
```

(velph_phelel_generate_subcommand)=
### `velph phelel generate`

VASP input files and job scripts are generated.

```bash
% velph phelel generate
VASP input files were generated in "phelel/disp-000".
VASP input files were generated in "phelel/disp-001".
VASP input files were generated in "phelel/disp-002".
VASP input files were generated in "phelel/disp-003".
VASP input files were generated in "phelel/disp-004".
```

(velph_phelel_differentiate_subcommand)=
### `velph phelel differentiate`

The derivatives of local potentials and PAW strengths with respect to
displacement are calculated and stored in `phelel_params.hdf5`.

```bash
% velph phelel differentiate
FFT mesh: [30 30 30].
Running finufft (eps=1.000e-06)...
Running finufft (eps=1.000e-06)...
"phelel/phelel_params.hdf5" has been made.
```

(velph_phelel_phonopy_subcommand)=
### `velph phelel phonopy`

```{note}
This subcommand is similar to `velph ph_bands`, but the phonon band structure is
calculated using the phonopy code. While the phonon calculation routines of VASP
and phonopy are expected to yield similar results, they are not entirely
equivalent. However, for electron-phonon calculations, the VASP routine is
utilized.
```

`phonopy_params.yaml` that contains information necessary for phonon calculation
by the phonopy code is generated from `phelel_disp.yaml` and the results of the
VASP inputs generated by `velph phelel generate`.

```bash
% velph phelel phonopy
"phelel/phonopy_params.yaml" has been made.
% phonopy-load phelel/phonopy_params.yaml --band auto -p
```

## `velph transport`

This subcommand is used to prepare VASP input files for calculating transport
properties based on electron-phonon interactions.

### `velph transport generate`

The VASP input files are prepared for transport property calculations. Users
should review the generated `INCAR` tags and modify them as necessary for the
target material. If results from `el_bands/dos` calculations are available, the
maximum band index for the self-energy calculation is estimated and written into
the `INCAR` file.

```bash
% velph transport generate
Found "el_bands/dos" directory. Estimate elph_selfen_band_stop.
  "elph_selfen_band_stop=5" in INCAR is set.
VASP input files were generated in "transport".
```

### `velph transport plot`

The following command opens a graphical window that contains plots of transport
properties in `vaspout.h5`.

```bash
% velph transport plot transport
```

The following command opens a graphical window that displays eigenvalues in the
Brillouin zone with non-zero and non-one occupations. The eigenvalues are
obtained from `vaspout.h5`, and their occupations are calculated based on the
temperature and Fermi level specified through the command options.

```bash
% velph transport plot eigenvalues
mu: 4.837002 eV
temperature: 300.000000 K
No eigenvalues to plot.
% velph transport plot eigenvalues --mu 4
```

The following command opens a graphical window that displays Fan self-energies.

```bash
% velph transport plot selfenergy
```

## `velph ph_bands`

This subcommand is used to prepare VASP input files for phonon band structure
calculation using the supercell force constants stored in `phelel_params.hdf5`,
and to plot the resulting data.

### `velph ph_bands generate`

The VASP input files including `QPOINTS` are prepared so that the
calculation results will be stored in `vaspout.h5`.

```bash
% velph ph_bands generate
VASP input files were made in "ph_bands/bands".
```

### `velph ph_bands plot`

The phonon band structure is plotted and saved in the `ph_bands.pdf` file.

```bash
% velph ph_bands plot
Phonon band structure plot was saved in "ph_bands/ph_bands.pdf".
```

## `velph phono3py`

### `velph phono3py init`

### `velph phono3py generate`

## `velph phonopy`

### `velph phonopy init`

### `velph phonopy generate`
